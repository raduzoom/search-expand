<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Expand – Demo (Skin loading + Themes)</title>
    <style>
        :root{
            color-scheme: dark;
        }
        *{ box-sizing: border-box; }
        body{
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            background: #0b1220;
            color: #e8eefc;
        }
        a{ color: #9cc3ff; }
        .page{
            max-width: 1100px;
            margin: 0 auto;
            padding: 28px 18px 60px;
        }
        .header{
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 18px;
        }
        .title h1{
            margin: 0 0 6px 0;
            font-size: 22px;
            letter-spacing: .2px;
        }
        .title p{
            margin: 0;
            color: rgba(232,238,252,.8);
            line-height: 1.35;
        }
        .pill{
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,.14);
            background: rgba(255,255,255,.06);
            color: rgba(232,238,252,.85);
            user-select: none;
            white-space: nowrap;
        }
        .grid{
            display: grid;
            grid-template-columns: 1.1fr .9fr;
            gap: 14px;
            align-items: start;
        }
        @media (max-width: 980px){
            .grid{ grid-template-columns: 1fr; }
        }
        .card{
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(255,255,255,.06);
            box-shadow: 0 8px 30px rgba(0,0,0,.25);
            overflow: hidden;
        }
        .card-header{
            padding: 14px 14px 12px;
            border-bottom: 1px solid rgba(255,255,255,.10);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .card-header h2{
            margin: 0;
            font-size: 14px;
            letter-spacing: .2px;
        }
        .card-body{ padding: 14px; }
        .muted{ color: rgba(232,238,252,.75); }
        .row{
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
        }
        .row + .row{ margin-top: 10px; }
        .field{
            display: grid;
            gap: 6px;
        }
        .field label{
            font-size: 12px;
            color: rgba(232,238,252,.75);
        }
        .input{
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,.14);
            background: rgba(5,10,20,.55);
            color: #e8eefc;
            outline: none;
        }
        .input:focus{
            border-color: rgba(156,195,255,.65);
            box-shadow: 0 0 0 3px rgba(156,195,255,.15);
        }
        .btns{
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .btn{
            border: 1px solid rgba(255,255,255,.14);
            background: rgba(255,255,255,.06);
            color: #e8eefc;
            border-radius: 10px;
            padding: 9px 11px;
            font-size: 13px;
            cursor: pointer;
            transition: transform .08s ease, background .15s ease, border-color .15s ease;
        }
        .btn:hover{ background: rgba(255,255,255,.10); }
        .btn:active{ transform: translateY(1px); }
        .btn.primary{
            background: rgba(156,195,255,.18);
            border-color: rgba(156,195,255,.35);
        }
        .btn.danger{
            background: rgba(255,107,107,.14);
            border-color: rgba(255,107,107,.3);
        }
        .btn.active{
            background: rgba(156,195,255,.35);
            border-color: rgba(156,195,255,.70);
        }
        .kv{
            display: grid;
            grid-template-columns: 160px 1fr;
            gap: 6px 10px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(5,10,20,.5);
            border: 1px solid rgba(255,255,255,.12);
            overflow: auto;
        }
        .kv div:nth-child(odd){
            color: rgba(232,238,252,.65);
        }
        .log{
            height: 240px;
            overflow: auto;
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(5,10,20,.5);
            border: 1px solid rgba(255,255,255,.12);
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            line-height: 1.35;
            white-space: pre-wrap;
        }
        .demo-area{
            display: grid;
            gap: 12px;
        }
        .demo-slot{
            border-radius: 14px;
            border: 1px dashed rgba(255,255,255,.18);
            background: rgba(255,255,255,.04);
            padding: 16px;
        }
        .demo-slot h3{
            margin: 0 0 8px 0;
            font-size: 13px;
            color: rgba(232,238,252,.92);
        }
        .demo-host{
            display: inline-block;
        }
        .hint{
            margin-top: 10px;
            font-size: 12px;
            color: rgba(232,238,252,.72);
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="header">
            <div class="title">
                <h1>Search Expand – Demo (skin loader + visible themes)</h1>
                <p>
                    This page avoids the old demo’s issues: there is no <code>setSkin()</code> on the traditional instance, and
                    the library’s default skin <code>basePath</code> is <code>/src/...</code> (which often breaks when hosted elsewhere).
                    Here we auto-configure a working basePath and provide a real-time log.
                </p>
            </div>
            <div class="pill" id="build-pill">Loading bundle…</div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <h2>Controls</h2>
                    <div class="muted" id="api-status">API: pending</div>
                </div>
                <div class="card-body">
                    <div class="field">
                        <label for="basePath">Skin basePath (where the CSS skin files live)</label>
                        <input id="basePath" class="input" spellcheck="false" />
                    </div>
                    <div class="row" style="margin-top: 10px;">
                        <div class="btns">
                            <button class="btn primary" id="applyConfig">Apply config</button>
                            <button class="btn" id="testBasePath">Test basePath</button>
                            <button class="btn" id="preloadAll">Preload all skins</button>
                            <button class="btn danger" id="clearLog">Clear log</button>
                        </div>
                        <div class="pill" id="timing-pill">Idle</div>
            </div>

                    <div style="margin-top: 12px;">
                        <div class="muted" style="font-size: 12px; margin-bottom: 6px;">Choose skin (loads CSS + applies demo theme variables)</div>
                        <div class="btns" id="skin-buttons">
                            <button class="btn active" data-skin="default">Default</button>
                            <button class="btn" data-skin="flat">Flat</button>
                            <button class="btn" data-skin="default-dark">Default Dark</button>
                            <button class="btn" data-skin="flat-dark">Flat Dark</button>
            </div>
        </div>

                    <div style="margin-top: 14px;">
                        <div class="muted" style="font-size: 12px; margin-bottom: 6px;">Runtime info</div>
                        <div class="kv" id="runtime-kv"></div>
                    </div>

                    <div style="margin-top: 14px;">
                        <div class="muted" style="font-size: 12px; margin-bottom: 6px;">Log</div>
                        <div class="log" id="log"></div>
                        <div class="hint">
                            Tip: open DevTools Network and click skins to see <code>skin-*.css</code> fetched on demand.
            </div>
        </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>Demos</h2>
                    <div class="muted">Traditional + Web Component</div>
                </div>
                <div class="card-body">
                    <div class="demo-area">
                        <div class="demo-slot">
                            <h3>Traditional JS API (SearchExpand.initSearchExpand)</h3>
                            <div id="traditional-demo" class="demo-host"></div>
                            <div class="hint">Submit via click icon or Enter; we’ll log the query.</div>
        </div>

                        <div class="demo-slot">
                            <h3>Web Component (&lt;dzs-search-expand&gt;)</h3>
                            <dzs-search-expand
                                id="wc-demo"
                                data-skin="default"
                                data-chip-selector-options='{"inputPlaceholderText":"Search..."}'
                                data-persistentOptions='[]'></dzs-search-expand>
                            <div class="hint">Skin changes update <code>data-skin</code> and call <code>setSkin()</code> when available.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../dist-webpack/search-expand.js"></script>
    
    <script>
        // ---- Small helper layer (keeps the demo resilient across different bundle styles)
        function getSearchExpandApi() {
            // Most builds expose window.SearchExpand (as used by other demos in this repo).
            if (window.SearchExpand) return window.SearchExpand;
            // Some bundles might expose the default export under a different global.
            if (window.searchExpand) return window.searchExpand;
            return null;
        }

        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => Array.from(document.querySelectorAll(sel));

        const $buildPill = $('#build-pill');
        const $timingPill = $('#timing-pill');
        const $apiStatus = $('#api-status');
        const $basePath = $('#basePath');
        const $log = $('#log');
        const $runtimeKv = $('#runtime-kv');
        const $skinButtons = $('#skin-buttons');
        const $traditionalHost = $('#traditional-demo');
        const $wc = $('#wc-demo');

        let traditionalInstance = null;
        let currentSkin = 'default';

        function nowTime() {
            const d = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }

        function log(line, level = 'info') {
            const prefix = level === 'error' ? '[error]' : (level === 'warn' ? '[warn]' : '[info]');
            $log.textContent += `${nowTime()} ${prefix} ${line}\n`;
            $log.scrollTop = $log.scrollHeight;
        }

        function setTiming(text) {
            $timingPill.textContent = text;
        }

        function setBuildStatus(text) {
            $buildPill.textContent = text;
        }

        function sanitizeBasePath(path) {
            if (!path) return '';
            // Ensure it ends with trailing slash so `${basePath}${file}` works.
            return path.endsWith('/') ? path : (path + '/');
        }

        function getDefaultBasePath() {
            // Page lives at `src/dynamic-skin-example.html`, skins at `src/dzs-search-expand/style/skins/`.
            // Use absolute URL so it also works when this file is hosted under a subpath.
            return new URL('./dzs-search-expand/style/skins/', window.location.href).toString();
        }

        // The library ships "skins" (CSS files), but the search-expand visuals are primarily driven by CSS variables.
        // To make skin switching visibly meaningful, we apply a "theme preset" (variables) in addition to loading the skin CSS.
        const THEME_PRESETS = {
            'default': {
                '--search-expand-color-wrapper-bg': '#222',
                '--search-expand-color-wrapper-bg-hover': '#2b2b2b',
                '--search-expand-color-icon': '#fff',
                '--search-expand-color-icon-hover': '#dadada',
                '--search-expand-color-text': '#fff',
                '--search-expand-expand-w': '220px'
            },
            'flat': {
                '--search-expand-color-wrapper-bg': '#f1f5ff',
                '--search-expand-color-wrapper-bg-hover': '#e6eeff',
                '--search-expand-color-icon': '#335bff',
                '--search-expand-color-icon-hover': '#2348e6',
                '--search-expand-color-text': '#0b1220',
                '--search-expand-expand-w': '240px'
            },
            'default-dark': {
                '--search-expand-color-wrapper-bg': '#0f172a',
                '--search-expand-color-wrapper-bg-hover': '#111c35',
                '--search-expand-color-icon': '#9cc3ff',
                '--search-expand-color-icon-hover': '#c8ddff',
                '--search-expand-color-text': '#e8eefc',
                '--search-expand-expand-w': '240px'
            },
            'flat-dark': {
                '--search-expand-color-wrapper-bg': '#111827',
                '--search-expand-color-wrapper-bg-hover': '#0b1220',
                '--search-expand-color-icon': '#34d399',
                '--search-expand-color-icon-hover': '#10b981',
                '--search-expand-color-text': '#e8eefc',
                '--search-expand-expand-w': '240px'
            }
        };

        function applyThemePreset(skin, el) {
            const preset = THEME_PRESETS[skin] || THEME_PRESETS['default'];
            Object.entries(preset).forEach(([k, v]) => el.style.setProperty(k, v));
        }

        function updateActiveSkinButtons() {
            $$('#skin-buttons .btn').forEach((b) => {
                b.classList.toggle('active', b.getAttribute('data-skin') === currentSkin);
            });
        }

        function updateRuntimeKv() {
            const api = getSearchExpandApi();
            const available = api && api.getAvailableSkins ? api.getAvailableSkins() : [];
            const loaded = api && api.getLoadedSkins ? api.getLoadedSkins() : [];
            const basePathValue = $basePath.value || '';

            $runtimeKv.innerHTML = `
                <div>location</div><div>${window.location.href}</div>
                <div>basePath</div><div>${basePathValue}</div>
                <div>currentSkin</div><div>${currentSkin}</div>
                <div>availableSkins</div><div>${Array.isArray(available) ? available.join(', ') : String(available)}</div>
                <div>loadedSkins</div><div>${Array.isArray(loaded) ? (loaded.join(', ') || 'none') : String(loaded)}</div>
            `;
        }

        async function applyConfig({ basePath, preloadSkins } = {}) {
            const api = getSearchExpandApi();
            if (!api || !api.configureSkinLoading) {
                log('SearchExpand API missing `configureSkinLoading` (bundle not loaded?)', 'error');
                return;
            }

            const cfg = {};
            if (typeof basePath === 'string') cfg.basePath = sanitizeBasePath(basePath);
            if (Array.isArray(preloadSkins)) cfg.preloadSkins = preloadSkins;

            api.configureSkinLoading(cfg);
            log(`Configured skin loading: ${JSON.stringify(cfg)}`);
            updateRuntimeKv();
        }

        async function testBasePath() {
            const basePath = sanitizeBasePath($basePath.value);
            const probeUrl = basePath + 'skin-default.css';
            setTiming('Testing…');
            try {
                const res = await fetch(probeUrl, { cache: 'no-store' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                log(`basePath OK: fetched ${probeUrl}`);
                setTiming('basePath OK');
            } catch (e) {
                log(`basePath FAILED: ${probeUrl} (${e && e.message ? e.message : e})`, 'error');
                setTiming('basePath failed');
            } finally {
                updateRuntimeKv();
            }
        }

        async function loadSkinWithTiming(skin) {
            const api = getSearchExpandApi();
            if (!api || !api.loadSkin) {
                log('SearchExpand API missing `loadSkin`', 'error');
                return { ok: false, ms: 0 };
            }
            const t0 = performance.now();
            try {
                await api.loadSkin(skin);
                const ms = Math.round(performance.now() - t0);
                return { ok: true, ms };
            } catch (e) {
                const ms = Math.round(performance.now() - t0);
                return { ok: false, ms, error: e };
            }
        }

        async function setSkin(skin) {
            currentSkin = skin;
            updateActiveSkinButtons();

            // Make it visibly change by swapping CSS variables.
            applyThemePreset(skin, $traditionalHost);
            applyThemePreset(skin, $wc);

            // Load the skin CSS via the library (so you can see network + loadedSkins update).
            setTiming(`Loading ${skin}…`);
            const result = await loadSkinWithTiming(skin);
            if (result.ok) {
                log(`Loaded skin "${skin}" in ${result.ms}ms`);
                setTiming(`${skin}: ${result.ms}ms`);
            } else {
                log(`Failed loading skin "${skin}" (${result.ms}ms): ${result.error && result.error.message ? result.error.message : result.error}`, 'error');
                setTiming(`${skin}: failed`);
            }

            // Update web component skin attribute + call method if available
            if ($wc) {
                try {
                    $wc.setAttribute('data-skin', skin);
                    if (typeof $wc.setSkin === 'function') {
                        await $wc.setSkin(skin);
                    }
                } catch (e) {
                    log(`Web component skin switch failed: ${e && e.message ? e.message : e}`, 'warn');
                }
            }

            updateRuntimeKv();
        }

        async function preloadAllSkins() {
            const api = getSearchExpandApi();
            if (!api || !api.preloadSkins) {
                log('SearchExpand API missing `preloadSkins`', 'error');
                return;
            }
            setTiming('Preloading…');
            const t0 = performance.now();
            try {
                await api.preloadSkins(['default', 'flat', 'default-dark', 'flat-dark']);
                const ms = Math.round(performance.now() - t0);
                log(`Preloaded all skins in ${ms}ms`);
                setTiming(`Preloaded: ${ms}ms`);
            } catch (e) {
                log(`Preload failed: ${e && e.message ? e.message : e}`, 'error');
                setTiming('Preload failed');
            } finally {
                updateRuntimeKv();
            }
        }

        function initDemos() {
            const api = getSearchExpandApi();
            if (!api) {
                $apiStatus.textContent = 'API: missing';
                setBuildStatus('Bundle not found (check script path)');
                log('window.SearchExpand is not present. Is `../dist-webpack/search-expand.js` reachable?', 'error');
                return;
            }

            $apiStatus.textContent = 'API: loaded';
            setBuildStatus('Bundle loaded');
            log(`SearchExpand loaded. Methods: ${Object.keys(api).join(', ')}`);

            // Init web components (defines <dzs-search-expand>)
            if (api.initWebComponents) {
                api.initWebComponents();
                log('Web components initialized');
            }

            // Init traditional demo
            if (api.initSearchExpand && $traditionalHost) {
                $traditionalHost.classList.add('search-expand', 'inline-block');
                traditionalInstance = api.initSearchExpand($traditionalHost, {
                    inputPlaceholderText: 'Search…',
                    onSubmitSearch: (q) => log(`Traditional submit: "${q}"`)
                });
                log('Traditional instance initialized');
            }
        }

        function wireUi() {
            $('#applyConfig').addEventListener('click', async () => {
                await applyConfig({ basePath: $basePath.value, preloadSkins: ['default'] });
                await setSkin(currentSkin);
            });

            $('#testBasePath').addEventListener('click', testBasePath);
            $('#preloadAll').addEventListener('click', preloadAllSkins);

            $('#clearLog').addEventListener('click', () => {
                $log.textContent = '';
                log('Log cleared');
            });

            $skinButtons.addEventListener('click', async (e) => {
                const btn = e.target.closest('button[data-skin]');
                if (!btn) return;
                await setSkin(btn.getAttribute('data-skin'));
            });
        }

        window.addEventListener('load', async () => {
            // Initialize UI defaults
            $basePath.value = getDefaultBasePath();
            wireUi();

            // Ensure library uses our basePath (the library default is `/src/...` which is often wrong).
            await applyConfig({ basePath: $basePath.value, preloadSkins: ['default'] });

            // Init components
            initDemos();

            // Apply initial skin
            await setSkin('default');

            updateRuntimeKv();
        });
    </script>
</body>
</html>




